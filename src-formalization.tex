%TODO remove parentheses around parameter lists: $\otimes$ and $\mathcal{D}$
%TODO add abstract machine semantics

In the formalization of the language we use an orientation parameter $\pol \in \{ \polprd,\polcon \}$ and functions

\begin{align*}
  \boxed{\polprd}
  :=\ >
  \quad
  \boxed{\polcon}
  :=\ <
  \qquad
  \widehat{\polprd}
  :=\ \polcon
  \quad
  \widehat{\polcon}
  :=\ \polprd
\end{align*}

\subsection{Syntax}

The syntax is defined in \cref{fig:?:syntax}.

\begin{figure}[H]
    \setlength{\abovedisplayskip}{0pt}
    \setlength{\belowdisplayskip}{0pt}
    \setlength{\abovedisplayshortskip}{0pt}
    \setlength{\belowdisplayshortskip}{0pt}
  \[
  \begin{array}{lclr}
    \multicolumn{4}{r}{
      i \in \mathbb{N}
      \quad
      \mathcal{M} \in \mu\textsc{Abs}
      \quad
      \mathcal{C} \in \textsc{Ctor}
      \quad
      \mathcal{D} \in \textsc{Dtor}
      \quad
      \mathcal{T} \in \textsc{Type}
      \mspace{60mu}
      \emph{Names}
    }
    \\
    \multicolumn{4}{r}{
      a \in \textsc{Contants}
      \mspace{60mu}
      \emph{Values}
    }
    \\[0.5cm]

    % Types
    T
    & \Coloneqq
    & \Bool\ |\ \Int\ |\ \mathcal{T}
    & \emph{Types}
    \\[0.5cm]

    % o-Signature
    \Sigma^{\pol}
    & \Coloneqq
    & \varnothing\ |\ \prdcon T
    & \emph{$\pol$-Signature}
    \\[0.5cm]

    % prd-Terms
    t^{\polprd}
    & \Coloneqq
    & \otimes\big(\overline{t^{\polprd}}\big)
    & \emph{Primitive-Operator-Application}
    \\
    & | & \mathcal{C}
    & \emph{Constructor}
    \\
    & | & \mathcal{C}\text{-}\mathcal{D}^{i}
    & \emph{$\polprd$-Parameter}
    \\
    & | & \mathcal{M}^{i}
    & \emph{$\mu$-Parameter}
    \\[0.5cm]

    % con-Terms
    t^{\polcon}
    & \Coloneqq
    & \mathcal{C}\text{-}\mathcal{D}_{i}
    & \emph{$\polcon$-Parameter}
    \\
    & | & \mathcal{D}\big(\overline{t^{\polprd}}\big)\big(\overline{t^{\polcon}}\big)
    & \emph{Destructor-Application}
    \\
    & | & \mathcal{M}
    & \emph{$\mu$-Abstraction}
    \\[0.5cm]

    % Commands
    c
    & \Coloneqq
    & t^{\polprd} \mkCmd t^{\polcon}
    & \emph{Command}
    \\[0.5cm]

    % Constructor-Definition
    C
    & \Coloneqq
    & \textsc{Ctor} \to \codata\
      \mathcal{T}\
      \where\
      \overline{\mathcal{D}\Sigma^{\polprd}\Sigma^{\polcon}}\
      := \match\
         \overline{c}
    & \emph{Constructor-Definitions}
    \\[0.5cm]

    % mu-Definition
    M
    & \Coloneqq
    & \mu\textsc{Abs} \to T\ \inin\ c
    & \emph{$\mu$-Definitions}
    \\[0.5cm]

    % Program
    P
    & \Coloneqq
    & 
      C
      \ \&\
      M
    & \emph{Program}
    \\[0.5cm]

    % prd-Values
    v^{\polprd}
    & \Coloneqq
    & a
    & \emph{Literal}
    \\
    & | & \langle \mathcal{C}, \sigma \rangle
    & \emph{Object}
    \\[0.5cm]

    % con-Values
    v^{\polcon}
    & \Coloneqq
    & \Done
    & \emph{Top-Level-Consumer}
    \\
    & | & \mathcal{D}\big(\overline{v^{\polprd}}\big)\big(\overline{v^{\polcon}}\big)
    & \emph{Observation}
    \\
    & | & \langle \mathcal{M}, \sigma \rangle
    & \emph{Continuation}
    \\[0.5cm]
  \end{array}
  \]
  \caption{Syntax.}
  \label{fig:?:syntax}
\end{figure}

\subsection{Semantic}
Define environments $\sigma$ as records
\begin{align*}
  \left\lbrace
    C:
      \textsc{Ctor}
      \to
      \text{List}
      \left(
        \left(
          V^{\polprd} \times \ldots \times V^{\polprd}
        \right),
        \left(
          V^{\polcon} \times \ldots \times V^{\polcon}
        \right)
      \right);
    M: \mu\textsc{Abs} \to V^{\polprd}
  \right\rbrace
  \\
\end{align*}

\begin{prooftree}
  \AxiomC{$
    P.C[\mathcal{C}].\mathcal{D}
    =
    t^{\polprd} \mkCmd t^{\polcon}
  $}
  \AxiomC{$
    \semtm{\sigma}{t^{\polprd}}{\langle \mathcal{C}^{\prime}, \sigma^{\prime} \rangle}
  $}
  \AxiomC{$
    \semtm
      {\sigma}
      {t^{\polcon}}
      {\mathcal{D}\big(\overline{v^{\polprd}}\big)\big(\overline{v^{\polcon}}\big)}
  $}
  \RightLabel{\textsc{E-Cmd-Ctor}}
  \TrinaryInfC{$
    \semcmd
      {P}
      {\sigma}
      {\mathcal{C}}
      {
        \sigma^{\prime}
        \left[
          \overline{\mathcal{C}\mathcal{D}^{i} \mapsto v_{i}^{\polprd}},
          \overline{\mathcal{C}\mathcal{D}_{i} \mapsto v_{i}^{\polcon}}
        \right]
      }
      {\mathcal{C}^{\prime}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.M[\mathcal{M}]
    =
    \ldots
    t^{\polprd} \mkCmd t^{\polcon}
  $}
  \AxiomC{$
    \semtm{\sigma}{t^{\polprd}}{v^{\polprd}}
  $}
  \AxiomC{$
    \semtm{\sigma}{t^{\polcon}}{\langle \mathcal{M}^{\prime}, \sigma^{\prime} \rangle}
  $}
  \RightLabel{\textsc{E-Cmd-$\mu$Abs}}
  \TrinaryInfC{$
    \semcmd
      {P}
      {\sigma}
      {\mathcal{M}}
      {\sigma^{\prime}[\mathcal{M}^{i} \mapsto v^{\polprd}]}
      {\mathcal{M}^{\prime}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.C[\mathcal{C}].\mathcal{D}
    =
    t^{\polprd} \mkCmd t^{\polcon}
  $}
  \AxiomC{$
    \semtm{\sigma}{t^{\polprd}}{v^{\polprd}}
  $}
  \AxiomC{$
    \semtm{\sigma}{t^{\polcon}}{\langle \mathcal{M}^{\prime}, \sigma^{\prime} \rangle}
  $}
  \RightLabel{\textsc{E-Cmd-Ctor-$\mu$Abs}}
  \TrinaryInfC{$
    \semcmd
      {P}
      {\sigma}
      {\mathcal{C}}
      {\sigma^{\prime}[\mathcal{M}^{i} \mapsto v^{\polprd}]}
      {\mathcal{M}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.M[\mathcal{M}]
    =
    \ldots
    t^{\polprd} \mkCmd t^{\polcon}
  $}
  \AxiomC{$
    \semtm{\sigma}{t^{\polprd}}{\langle \mathcal{C}, \sigma^{\prime} \rangle}
  $}
  \AxiomC{$
    \semtm
      {\sigma}
      {t^{\polcon}}
      {\mathcal{D}\big(\overline{v^{\polprd}}\big)\big(\overline{v^{\polcon}}\big)}
  $}
  \RightLabel{\textsc{E-Cmd-$\mu$Abs-Ctor}}
  \TrinaryInfC{$
    \semcmd
      {P}
      {\sigma}
      {\mathcal{M}}
      {
        \sigma^{\prime}
        \left[
          \overline{\mathcal{C}\mathcal{D}^{i} \mapsto v_{i}^{\polprd}},
          \overline{\mathcal{C}\mathcal{D}_{i} \mapsto v_{i}^{\polcon}}
        \right]
      }
      {\mathcal{C}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    \overline{\semtm{\sigma}{t^{\polprd}}{v^{\polprd}}}
  $}
  \RightLabel{\textsc{E-PrimOpApp}}
  \UnaryInfC{$
    \semtm
      {\sigma}
      {\otimes\big(\overline{t^{\polprd}}\big)}
      {\tilde{\otimes}\big(\overline{v^{\polprd}}\big)}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    \text{lookup}(\sigma.C[\mathcal{C}], \mathcal{D})
    =
    \left(
      \left(
        \ldots,
        v_{i}^{\polprd},
        \ldots
      \right),
      \left(
        \ldots
      \right)
    \right)
  $}
  \RightLabel{\textsc{E-$\polprd$-Param}}
  \UnaryInfC{$
    \semtm{\sigma}{\mathcal{C}\text{-}\mathcal{D}^{i}}{v_{i}^{\polprd}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{}
  \RightLabel{\textsc{E-Ctor}}
  \UnaryInfC{$
    \semtm
      {\sigma}
      {\mathcal{C}}
      {\langle \mathcal{C}, \sigma \rangle}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    \sigma.M[\mathcal{M}]
    =
    v^{\polprd}
  $}
  \RightLabel{\textsc{E-$\mu$-Param}}
  \UnaryInfC{$
    \semtm{\sigma}{\mathcal{M}_{i}}{v^{\polprd}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    \text{lookup}(\sigma.C[\mathcal{C}], \mathcal{D})
    =
    \left(
      \left(
        \ldots
      \right),
      \left(
        \ldots,
        v_{i}^{\polcon},
        \ldots
      \right)
    \right)
  $}
  \RightLabel{\textsc{E-$\polcon$-Param}}
  \UnaryInfC{$
    \semtm{\sigma}{\mathcal{C}\text{-}\mathcal{D}_{i}}{v_{i}^{\polprd}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    \overline{\semtm{\sigma}{t^{\polprd}}{v^{\polprd}}}
  $}
  \AxiomC{$
    \overline{\semtm{\sigma}{t^{\polcon}}{v^{\polcon}}}
  $}
  \RightLabel{\textsc{E-DtorApp}}
  \BinaryInfC{$
    \semtm
      {\sigma}
      {\mathcal{D}\big(\overline{t^{\polprd}}\big)\big(\overline{t^{\polcon}}\big)}
      {\mathcal{D}\big(\overline{v^{\polprd}}\big)\big(\overline{v^{\polcon}}\big)}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{}
  \RightLabel{\textsc{E-$\mu$Abs}}
  \UnaryInfC{$
    \semtm
      {\sigma}
      {\mathcal{M}}
      {\langle \mathcal{M}, \sigma \rangle}
  $}
\end{prooftree}
\vspace*{0.3cm}

\subsection{Typing}

\begin{prooftree}
  \AxiomC{$
    T
    =
    \text{check}_{\otimes}\big(\overline{t^{\polprd}}\big)
  $}
  \RightLabel{\textsc{Tm-PrimOpApp}}
  \UnaryInfC{$
    \typetmprd{P}{\otimes\big(\overline{t^{\polprd}}\big)}{T}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.C[\mathcal{C}]
    =
    \codata\ \mathcal{T} \ldots
  $}
  \RightLabel{\textsc{Tm-Ctor}}
  \UnaryInfC{$
    \typetmprd{P}{\mathcal{C}}{\mathcal{T}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.C[\mathcal{C}]
    =
    \ldots \where \ldots \mathcal{D}\Sigma^{\polprd}\Sigma^{\polcon} \ldots
  $}
  \AxiomC{$
    T
    =
    \Sigma^{\polprd}(i)
  $}
  \RightLabel{\textsc{Tm-$\polprd$-Param}}
  \BinaryInfC{$
    \typetmprd{P}{\mathcal{C}\text{-}\mathcal{D}^{i}}{T}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.M[\mathcal{M}]
    =
    T\ \inin\ \ldots
  $}
  \RightLabel{\textsc{Tm-$\mu$-Param}}
  \UnaryInfC{$
    \typetmprd{P}{\mathcal{M}^{i}}{T}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.C[\mathcal{C}]
    =
    \ldots \where \ldots \mathcal{D}\Sigma^{\polprd}\Sigma^{\polcon} \ldots
  $}
  \AxiomC{$
    T
    =
    \Sigma^{\polcon}(i)
  $}
  \RightLabel{\textsc{Tm-$\polcon$-Param}}
  \BinaryInfC{$
    \typetmcon{P}{\mathcal{C}\text{-}\mathcal{D}_{i}}{T}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    (\Sigma^{\polprd}, \Sigma^{\polcon})
    =
    \text{Sig}(\mathcal{D}, \mathcal{T}, P)
  $}
  \AxiomC{$
    \forall i,\, \typetmprd{P}{t_{i}^{\polprd}}{\Sigma^{\polprd}(i)}
  $}
  \AxiomC{$
    \forall i,\, \typetmcon{P}{t_{i}^{\polcon}}{\Sigma^{\polcon}(i)}
  $}
  \RightLabel{\textsc{Tm-DtorApp}}
  \TrinaryInfC{$
    \typetmcon
      {P}
      {\mathcal{D}\big(\overline{t^{\polprd}}\big)\big(\overline{t^{\polcon}}\big)}
      {\mathcal{T}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    P.M[\mathcal{M}]
    =
    T\ \inin\ \ldots
  $}
  \RightLabel{\textsc{Tm-$\mu$Abs}}
  \UnaryInfC{$
    \typetmcon{P}{\mathcal{M}}{T}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$
    \typetmprd{P}{t^{\polprd}}{T}
  $}
  \AxiomC{$
    \typetmcon{P}{t^{\polcon}}{T}
  $}
  \RightLabel{\textsc{Cmd-Cut}}
  \BinaryInfC{$
    \typecmd{P}{t^{\polprd} \mkCmd t^{\polcon}}
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\forall \mathcal{C},\, \overline{\typecmd{P}{c}}$}
  \RightLabel{\textsc{Wf-Ctor}}
  \UnaryInfC{$
    \typewf{
      \textsc{Ctor}
      \to
      \codata\
      \mathcal{T}\
      \where\
      \overline{\mathcal{D}\Sigma^{\polprd}\Sigma^{\polcon}}\
      := \match\
         \overline{c}
    }
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\typecmd{P}{c}$}
  \RightLabel{\textsc{Wf-$\mu$}}
  \UnaryInfC{$
    \typewf{
      \mu\textsc{Abs}
      \to
      T\ \inin\ c
    }
  $}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\typewf{C}$}
  \AxiomC{$\typewf{M}$}
  \RightLabel{\textsc{Wf-Program}}
  \BinaryInfC{$\typewf{C\ \&\ M}$}
\end{prooftree}
\vspace*{0.3cm}

\subsection{Liveness}
Let $\mathcal{L} \in \mu\textsc{Abs} \cup \textsc{Ctor}$ and define $\textsc{Scope}_{P}(\mathcal{L}_{e}) := \lbrace \mathcal{L} \,|\, \liveness{P}{\mathcal{L}_{e}}{\mathcal{L}} \rbrace$ where
\\
\begin{prooftree}
  \AxiomC{$\mathcal{C} \neq \mathcal{C}^{\prime}$}
  \AxiomC{$P.C[\mathcal{C}^{\prime}] = \ldots \overline{c_{\mathcal{C}^{\prime}}}$}
  \AxiomC{$
    \exists
    \mathcal{D}^{i},\,
    \mathcal{C}\text{-}\mathcal{D}^{i} \leq c_{\mathcal{C}^{\prime}}
    \,
    \lor
    \,
    \ldots
  $}
  \RightLabel{\textsc{Live-$\polprd$-Param}}
  \TrinaryInfC{$\liveness{P}{\mathcal{C}}{\mathcal{C}^{\prime}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\mathcal{C} \neq \mathcal{C}^{\prime}$}
  \AxiomC{$P.C[\mathcal{C}^{\prime}] = \ldots \overline{c_{\mathcal{C}^{\prime}}}$}
  \AxiomC{$
    \exists
    \mathcal{D}_{i},\,
    \mathcal{C}\text{-}\mathcal{D}_{i} \leq c_{\mathcal{C}^{\prime}}
    \,
    \lor
    \,
    \ldots
  $}
  \RightLabel{\textsc{Live-$\polcon$-Param}}
  \TrinaryInfC{$\liveness{P}{\mathcal{C}}{\mathcal{C}^{\prime}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\mathcal{U} \neq \mathcal{U}^{\prime}$}
  \AxiomC{$P.M[\mathcal{U}^{\prime}] = \ldots c_{\mathcal{U}^{\prime}}$}
  \AxiomC{$
    \exists
    i,\,
    \mathcal{U}^{i} \leq c_{\mathcal{U}^{\prime}}
  $}
  \RightLabel{\textsc{Live-$\mu$-Param}}
  \TrinaryInfC{$\liveness{P}{\mathcal{U}}{\mathcal{U^{\prime}}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$P.C[\mathcal{C}] = \ldots \overline{c_{\mathcal{C}}}$}
  \AxiomC{$
    \exists
    i,\,
    \mathcal{U}^{i} \leq c_{\mathcal{C}}
    \,
    \lor
    \,
    \ldots
  $}
  \RightLabel{\textsc{Live-$\mu$-Param-Ctor}}
  \BinaryInfC{$\liveness{P}{\mathcal{U}}{\mathcal{C}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$P.M[\mathcal{U}] = \ldots c_{\mathcal{U}}$}
  \AxiomC{$
    \exists
    \mathcal{D}^{i},\,
    \mathcal{C}\text{-}\mathcal{D}^{i} \leq c_{\mathcal{U}}
  $}
  \RightLabel{\textsc{Live-$\polprd$-Param-$\mu$Abs}}
  \BinaryInfC{$\liveness{P}{\mathcal{C}}{\mathcal{U}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$P.M[\mathcal{U}] = \ldots c_{\mathcal{U}}$}
  \AxiomC{$
    \exists
    \mathcal{D}_{i},\,
    \mathcal{C}\text{-}\mathcal{D}_{i} \leq c_{\mathcal{U}}
  $}
  \RightLabel{\textsc{Live-$\polcon$-Param-$\mu$Abs}}
  \BinaryInfC{$\liveness{P}{\mathcal{C}}{\mathcal{U}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\mathcal{C} \neq \mathcal{C}^{\prime}$}
  \AxiomC{$\liveness{P}{\mathcal{C}}{\mathcal{L}}$}
  \AxiomC{$P.C[\mathcal{C}^{\prime}] = \ldots \overline{c_{\mathcal{C}^{\prime}}}$}
  \AxiomC{$
    \mathcal{L} \leq c_{\mathcal{C}^{\prime}}
    \,
    \lor
    \,
    \ldots
  $}
  \RightLabel{\textsc{Live-Ctor}}
  \QuaternaryInfC{$\liveness{P}{\mathcal{C}}{\mathcal{C}^{\prime}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\mathcal{U} \neq \mathcal{U}^{\prime}$}
  \AxiomC{$\liveness{P}{\mathcal{U}}{\mathcal{L}}$}
  \AxiomC{$P.M[\mathcal{U}^{\prime}] = \ldots c_{\mathcal{U}^{\prime}}$}
  \AxiomC{$
    \mathcal{L} \leq c_{\mathcal{U}^{\prime}}
  $}
  \RightLabel{\textsc{Live-$\mu$Abs}}
  \QuaternaryInfC{$\liveness{P}{\mathcal{U}}{\mathcal{U}^{\prime}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\liveness{P}{\mathcal{U}}{\mathcal{L}}$}
  \AxiomC{$P.C[\mathcal{C}] = \ldots \overline{c_{\mathcal{C}}}$}
  \AxiomC{$
    \mathcal{L} \leq c_{\mathcal{C}}
    \,
    \lor
    \,
    \ldots
  $}
  \RightLabel{\textsc{Live-$\mu$Abs-Ctor}}
  \TrinaryInfC{$\liveness{P}{\mathcal{U}}{\mathcal{C}}$}
\end{prooftree}
\vspace*{0.3cm}

\begin{prooftree}
  \AxiomC{$\liveness{P}{\mathcal{C}}{\mathcal{L}}$}
  \AxiomC{$P.M[\mathcal{U}] = \ldots c_{\mathcal{U}}$}
  \AxiomC{$
    \mathcal{L} \leq c_{\mathcal{U}}
  $}
  \RightLabel{\textsc{Live-Ctor-$\mu$Abs}}
  \TrinaryInfC{$\liveness{P}{\mathcal{C}}{\mathcal{U}}$}
\end{prooftree}
\vspace*{0.3cm}
